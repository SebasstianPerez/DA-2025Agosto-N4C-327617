<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emular Tr√°nsito - Administrador</title>
    <link rel="stylesheet" href="style/emularTransito.css">

    <script src="vistaWeb.js"></script>
</head>

<body>
    <script src="utilesVista.js"></script>

    <div class="emulacion-container">

        <div class="main-container">
            <header class="emulacion-header">
                <h2>üö¶ Emular tr√°nsito</h2>
                <p>Seleccione un puesto, verifique sus tarifas, ingrese una matr√≠cula y emule un tr√°nsito.</p>
            </header>

            <div class="emulacion-card card">
                <div class="form-grid">
                    <div class="form-input-column">
                        <label for="puesto">Puesto</label>
                        <select id="puesto" name="puesto" class="input-field">
                            <option value="" disabled selected>Seleccione un puesto</option>
                        </select>

                        <label for="matricula">Matr√≠cula</label>
                        <input type="text" id="matricula" name="matricula" placeholder="EJ: ABC1234"
                            class="input-field">

                        <label for="fechaHora">Fecha y hora del tr√°nsito</label>
                        <input type="datetime-local" id="fechaHora" name="fechaHora" placeholder="EJ: 2025-11-19 15:30"
                            class="input-field">
                    </div>

                    <div class="tarifas-column">
                        <span class="tarifas-title">Tarifas del puesto</span>
                        <div id="tabla-tarifas" class="table-content">
                            <div class="tarifas-muestra">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Categor√≠a</th>
                                            <th>Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>A (Auto)</td>
                                            <td>$ 120.00</td>
                                        </tr>
                                        <tr>
                                            <td>B (Camioneta)</td>
                                            <td>$ 180.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <p class="tarifas-info">Se muestran categor√≠a y monto actuales del puesto seleccionado.</p>
                    </div>
                </div>

                <button id="btn-emular-transito" class="btn-primary">Emular tr√°nsito</button>

                <div class="resultado-seccion" id="resultado-transito">
                    <h3 class="resultado-title">Resultado</h3>
                    <p><strong>Propietario:</strong> <span id="prop-nombre">Juan P√©rez</span> (<span
                            id="prop-estado">Activo</span>)</p>
                    <p><strong>Categor√≠a:</strong> <span id="transito-categoria">A (Auto)</span></p>
                    <p><strong>Bonificaci√≥n:</strong> <span id="transito-bonificacion">Residente Costa de Oro
                            (10%)</span></p>
                    <p><strong>Costo del tr√°nsito:</strong> <span id="transito-costo">$ 120.00</span></p>
                    <p><strong>Saldo luego del tr√°nsito:</strong> <span id="saldo-luego">$ 1400.75</span></p>
                </div>
            </div>

            <div class="asignacion-card card">
                <header class="card-header">
                    <h3>Asignar bonificaciones</h3>
                </header>

                <div class="form-grid-2-col">
                    <div class="col-left">
                        <label for="bonificaciones-select">Bonificaciones definidas</label>
                        <select id="bonificaciones-select" class="input-field">
                            <option>Residente Costa de Oro</option>
                        </select>

                        <label for="puestos-select">Puestos definidos</label>
                        <select id="puestos-select" class="input-field">
                            <option>Puesto 204 - Ruta Interbalnearia</option>
                        </select>
                    </div>

                    <div class="col-right">
                        <label for="cedula-input">C√©dula de identidad</label>
                        <div class="busqueda-propietario">
                            <input type="text" id="cedula-input" placeholder="12345678" class="input-field">
                            <button id="btn-buscar-propietario" class="btn-primary">Buscar propietario</button>
                        </div>

                        <div class="propietario-resumen">
                            <strong>Propietario</strong>
                            <p>Nombre: <span id="prop-asignacion-nombre">Propietario Demo 12345678</span></p>
                            <p>Estado: <span id="prop-asignacion-estado">Activo</span></p>
                        </div>

                        <div class="bonificaciones-asignadas">
                            <h4>Bonificaciones asignadas</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Bonificaci√≥n</th>
                                            <th>Puesto</th>
                                            <th>Fecha asignaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="3">Sin bonificaciones asignadas</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="asignar-nueva">
                            <h4>Asignar nueva bonificaci√≥n</h4>
                            <p>Seleccione bonificaci√≥n y puesto en las listas de la izquierda y luego asigne.</p>
                            <button id="btn-asignar-bonificacion" class="btn-primary">Asignar bonificaci√≥n</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer-admin">
            ¬© 2025 - Administraci√≥n
        </footer>
        <script>
            // ... Todo el c√≥digo JavaScript va aqu√≠
            urlIniciarVista = '/transito/inicializarVista'; // Endpoint para cargar puestos y tarifas iniciales

            // Variable global para almacenar todos los puestos con sus tarifas. 
            let puestosConTarifas = [];
            let inputCedula;
            let selectPuesto;
            let selectBonificacion;
            let btnAsignarBonificacion;

            // --- FUNCI√ìN AUXILIAR DE PINTADO DE TARIFAS ---
            function mostrar_tarifasPuesto(tarifas) {
                const contenedorTabla = document.getElementById('tabla-tarifas');

                if (!tarifas || tarifas.length === 0) {
                    contenedorTabla.innerHTML = '<p class="tarifas-info">No se encontraron tarifas para este puesto.</p>';
                    return;
                }

                // Se asume que 'crearTablaDesdeJson' existe en utilesVista.js
                const htmlTabla = crearTablaDesdeJson(tarifas);

                contenedorTabla.innerHTML = `
            <span class="tarifas-title">Tarifas del puesto</span>
            <div class="tarifas-muestra">
                ${htmlTabla}
                <p class="tarifas-info">Se muestran categor√≠a y monto actuales del puesto seleccionado.</p>
            </div>
        `;
            }

            // --- FUNCIONES ESPEC√çFICAS DE CARGA (Para llenar los selects) ---

            function mostrar_puestos(puestos) {
                puestosConTarifas = puestos;
                const selectPuestoEmular = document.getElementById('puesto');
                const selectPuestoAsignacion = document.getElementById('puestos-select');

                // 1. Limpiar opciones previas
                const defaultOption = '<option value="" disabled selected>Seleccione un puesto</option>';
                selectPuestoEmular.innerHTML = defaultOption;
                selectPuestoAsignacion.innerHTML = defaultOption;

                // 2. Llenar AMBOS selects con los puestos
                puestosConTarifas.forEach(puesto => {

                    // El 'nombre' es el identificador √∫nico (ej: "Accesos-101") que usa el backend.
                    const claveUnica = puesto.direccion;

                    // El texto visible puede ser el 'nombre' o la 'direccion' descriptiva.
                    const textoVisible = puesto.nombre + ' (' + puesto.direccion + ')';

                    if (claveUnica) {
                        const option = document.createElement('option');

                        // ‚úÖ CORRECCI√ìN CLAVE: El valor enviado al backend
                        option.value = claveUnica;
                        option.textContent = textoVisible;

                        console.log(`‚úÖ Agregando puesto al select (Valor: ${option.value} | Texto: ${option.textContent})`);

                        // Llenar ambos selects
                        selectPuestoEmular.appendChild(option.cloneNode(true));
                        selectPuestoAsignacion.appendChild(option);
                    }
                });

                // 3. Inicializar el primer puesto y mostrar tarifas
                if (puestosConTarifas.length > 0) {
                    const primerPuesto = puestosConTarifas[0];

                    // Usamos la clave √∫nica para setear el valor inicial
                    selectPuestoEmular.value = primerPuesto.nombre;

                    mostrar_tarifasPuesto(primerPuesto.tarifas);
                }
            }

            function mostrar_propietario(data) {
                if (!data) {
                    mostrar_error("Error: Propietario no encontrado o datos incompletos.");
                    return;
                }

                // A. Actualizar la informaci√≥n del propietario
                document.getElementById('prop-asignacion-nombre').textContent = data.nombre;
                document.getElementById('prop-asignacion-estado').textContent = data.estado;

                // --- B. CARGAR TABLA DE BONIFICACIONES ASIGNADAS CON crearTablaDesdeJson ---

                // 1. Obtener el contenedor de la tabla (usando la estructura de tu HTML)
                const contenedorTabla = document.querySelector('.bonificaciones-asignadas .table-container');

                // 2. Determinar la fuente de datos (asumiendo que es 'bonificacionesAsignadas' o 'bonificaciones')
                const bonificaciones = data.bonificacionesAsignadas || data.bonificaciones;

                // 3. Generar el HTML de la tabla
                const htmlTabla = crearTablaDesdeJson(bonificaciones);

                // 4. Inyectar el HTML en el contenedor
                contenedorTabla.innerHTML = htmlTabla;

                // 5. Agregar el t√≠tulo (si tu HTML lo ten√≠a por separado, aseg√∫rate de mantenerlo)
                const h4Title = document.createElement('h4');
                h4Title.textContent = 'Bonificaciones asignadas';
                contenedorTabla.prepend(h4Title);

                // Opcional: Mostrar un mensaje de √©xito
                mostrar_mensajeExito(`Propietario ${data.nombre} encontrado correctamente.`);
            }

            // --- FUNCI√ìN LLAMADA AUTOM√ÅTICAMENTE POR EL SISTEMA ---
            /**
             * Se llama autom√°ticamente al recibir la clave "bonificaciones".
             * @param {Array<String>} bonificaciones - Lista de nombres de bonificaciones (strings).
             */
            function mostrar_bonificaciones(bonificaciones) {
                const selectBonificaciones = document.getElementById('bonificaciones-select');

                console.log("Bonificaciones recibidas (ARRAY DE STRINGS):", bonificaciones);

                // 1. Limpiar select
                selectBonificaciones.innerHTML = '<option value="" disabled selected>Seleccione una bonificaci√≥n</option>';

                // 2. Llenar el select con los nombres de las bonificaciones
                bonificaciones.forEach(nombre => {

                    // La variable 'nombre' ya contiene el string de la bonificaci√≥n
                    // Verificaci√≥n clave: Asegurarse de que el string exista y no sea 'Null' o vac√≠o
                    if (nombre && typeof nombre === 'string' && nombre.trim().length > 0) {

                        console.log("Agregando bonificaci√≥n al select:", nombre);
                        const option = document.createElement('option');

                        // Usamos la variable 'nombre' directamente para el valor y el texto
                        option.value = nombre;
                        option.textContent = nombre;

                        selectBonificaciones.appendChild(option);
                    } else {
                        console.log("Bonificaci√≥n ignorada ('Null' o vac√≠a):", nombre);
                    }
                });
            }

            document.addEventListener("DOMContentLoaded", function () {
                // Aseg√∫rate de iniciar la vista al cargar la p√°gina si a√∫n no lo haces
                // La funci√≥n 'submit' debe ser llamada aqu√≠ o al inicio de la p√°gina
                // para traer los datos. (ejemplo: submit(urlIniciarVista); )



                const btnBuscarPropietario = document.getElementById('btn-buscar-propietario');
                inputCedula = document.getElementById('cedula-input');

                // C) MANEJO DEL BOT√ìN DE BUSCAR PROPIETARIO
                btnBuscarPropietario.addEventListener('click', function () {
                    const cedula = inputCedula.value;

                    if (!cedula || cedula.trim() === '') {
                        mostrarMensaje("Debe ingresar un n√∫mero de c√©dula.", 'warning');
                        return;
                    }

                    // Asumiendo que tu sistema usa 'submit' para llamadas POST
                    const parametros = `cedula=${encodeURIComponent(cedula)}`;
                    submit('/usuario/obtenerUsuario', parametros, 'POST');
                });

                selectPuesto = document.getElementById('puestos-select');
                const btnEmular = document.getElementById('btn-emular-transito');

                // A) MANEJO DEL CAMBIO DE PUESTO (ACTUALIZAR TARIFAS)
                selectPuesto.addEventListener('change', function () {
                    const puestoDireccion = this.value;
                    const puestoSeleccionado = puestosConTarifas.find(p => p.direccion === puestoDireccion);

                    if (puestoSeleccionado && puestoSeleccionado.tarifas) {
                        mostrar_tarifasPuesto(puestoSeleccionado.tarifas);
                    } else {
                        document.getElementById('tabla-tarifas').innerHTML = '<p class="tarifas-info">No se encontraron tarifas.</p>';
                    }
                });

                btnAsignarBonificacion = document.getElementById('btn-asignar-bonificacion');
                selectBonificacion = document.getElementById('bonificaciones-select'); // Select de bonificaciones definidas

                btnAsignarBonificacion.addEventListener('click', function () {
                    // 1. Obtener valores
                    const cedula = inputCedula.value;
                    const puestoDireccion = selectPuesto.value;
                    const bonificacionNombre = selectBonificacion.value;

                    // 2. Validaciones
                    if (!cedula || cedula.trim() === '') {
                        mostrarMensaje("Debe buscar un propietario e ingresar su c√©dula.", 'warning');
                        return;
                    }
                    if (!puestoDireccion) {
                        mostrarMensaje("Debe seleccionar un puesto para la asignaci√≥n.", 'warning');
                        return;
                    }
                    if (!bonificacionNombre) {
                        mostrarMensaje("Debe seleccionar una bonificaci√≥n.", 'warning');
                        return;
                    }

                    // 3. Preparar par√°metros
                    const parametros =
                        `puestoDireccion=${encodeURIComponent(puestoDireccion)}` +
                        `&bonificacionNombre=${encodeURIComponent(bonificacionNombre)}` +
                        `&cedula=${encodeURIComponent(cedula)}`;

                    // console.log("Asignando bonificaci√≥n con par√°metros:", parametros);

                    const url = '/usuario/asignarBonificacion';

                    // 4. Llamar al backend usando la funci√≥n 'submit'
                    // El resultado de esta llamada lo procesar√° la funci√≥n de callback 'mostrar_exito' o 'mostrar_error'.
                    submit(url, parametros, 'POST');
                });

                // B) MANEJO DEL BOT√ìN DE EMULACI√ìN (SUBMIT)
                btnEmular.addEventListener('click', function () {
                    const puestoDireccion = selectPuesto.value;
                    const matricula = document.getElementById('matricula').value;
                    const fechaHora = document.getElementById('fechaHora').value;

                    if (!puestoDireccion || !matricula || !fechaHora) {
                        mostrarMensaje("Debe seleccionar un puesto e ingresar matr√≠cula y fecha/hora.");
                        return;
                    }

                    const parametros =
                        `puestoDireccion=${encodeURIComponent(puestoDireccion)}` +
                        `&matricula=${encodeURIComponent(matricula)}` +
                        `&fechaHora=${encodeURIComponent(fechaHora)}`;

                    submit('/transito/emular', parametros, 'POST');
                });
            });

            function mostrar_exito(mensaje) {
                // El mensaje 'mensaje' vendr√° como 'null' en este caso, por lo que usamos uno predeterminado
                const mensajeFinal = mensaje || "Bonificaci√≥n asignada con √©xito.";

                // 1. Mostrar mensaje de √©xito
                mostrarMensaje(mensajeFinal, 'success');

                // 2. Re-consultar los datos del propietario para actualizar la tabla de bonificaciones asignadas
                // Esto asegura que la tabla refleje el cambio inmediatamente.
                const cedula = inputCedula.value;
                const parametros = `cedula=${encodeURIComponent(cedula)}`;
                submit('/usuario/obtenerUsuario', parametros, 'POST');
            }

            // --- FUNCIONES DE RESULTADO DE EMULACI√ìN (Mantenidas) ---
            function mostrar_resultadoEmulacion(data) {
                document.getElementById('prop-nombre').textContent = data.propietarioNombre;
                document.getElementById('prop-estado').textContent = data.propietarioEstado;
                document.getElementById('transito-categoria').textContent = data.categoria;
                document.getElementById('transito-bonificacion').textContent = data.bonificacionNombre || 'Ninguna';

                document.getElementById('transito-costo').textContent = `$ ${data.costoTransito.toFixed(2)}`;
                document.getElementById('saldo-luego').textContent = `$ ${data.saldoLuego.toFixed(2)}`;
            }

            function mostrar_error(mensaje) {
                mostrarMensaje(`Error en la operaci√≥n: ${mensaje}`, 'error');
            }

            function mostrar_mensajeExito(mensaje) {
                mostrarMensaje(mensaje, 'success');
            }

        </script>
</body>

</html>