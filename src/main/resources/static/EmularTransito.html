<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emular Tr√°nsito - Administrador</title>
    <link rel="stylesheet" href="style/emularTransito.css">

    <script src="vistaWeb.js"></script>
</head>

<body>
    <script src="utilesVista.js"></script>

    <div class="emulacion-container">

        <div class="main-container">
            <header class="emulacion-header">
                <h2>üö¶ Emular tr√°nsito</h2>
                <p>Seleccione un puesto, verifique sus tarifas, ingrese una matr√≠cula y emule un tr√°nsito.</p>

                <div class="dashboard-header">
                    <h1>Tablero de control del propietario</h1>
                    <a href="#" class="salir-link">Salir</a>
                </div>
            </header>

            <div class="emulacion-card card">
                <div class="form-grid">
                    <div class="form-input-column">
                        <label for="puesto">Puesto</label>
                        <select id="puesto" name="puesto" class="input-field">
                            <option value="" disabled selected>Seleccione un puesto</option>
                        </select>

                        <label for="matricula">Matr√≠cula</label>
                        <input type="text" id="matricula" name="matricula" placeholder="EJ: ABC1234"
                            class="input-field">

                        <label for="fechaHora">Fecha y hora del tr√°nsito</label>
                        <input type="datetime-local" id="fechaHora" name="fechaHora" placeholder="EJ: 2025-11-19 15:30"
                            class="input-field">
                    </div>

                    <div class="tarifas-column">
                        <span class="tarifas-title">Tarifas del puesto</span>
                        <div id="tabla-tarifas" class="table-content">
                            <div class="tarifas-muestra">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Categor√≠a</th>
                                            <th>Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>A (Auto)</td>
                                            <td>$ 120.00</td>
                                        </tr>
                                        <tr>
                                            <td>B (Camioneta)</td>
                                            <td>$ 180.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <p class="tarifas-info">Se muestran categor√≠a y monto actuales del puesto seleccionado.</p>
                    </div>
                </div>

                <button id="btn-emular-transito" class="btn-primary">Emular tr√°nsito</button>

                <div class="resultado-seccion" id="resultado-transito">
                    <h3 class="resultado-title">Resultado</h3>
                    <p><strong>Propietario:</strong> <span id="prop-nombre">Juan P√©rez</span> (<span
                            id="prop-estado">Activo</span>)</p>
                    <p><strong>Categor√≠a:</strong> <span id="transito-categoria">A (Auto)</span></p>
                    <p><strong>Bonificaci√≥n:</strong> <span id="transito-bonificacion">Residente Costa de Oro
                            (10%)</span></p>
                    <p><strong>Costo del tr√°nsito:</strong> <span id="transito-costo">$ 120.00</span></p>
                    <p><strong>Saldo luego del tr√°nsito:</strong> <span id="saldo-luego">$ 1400.75</span></p>
                </div>
            </div>

            <div class="asignacion-card card">
                <header class="card-header">
                    <h3>Asignar bonificaciones</h3>
                </header>

                <div class="form-grid-2-col">
                    <div class="col-left">
                        <label for="bonificaciones-select">Bonificaciones definidas</label>
                        <select id="bonificaciones-select" class="input-field">
                            <option>Residente Costa de Oro</option>
                        </select>

                        <label for="puestos-select">Puestos definidos</label>
                        <select id="puestos-select" class="input-field">
                            <option>Puesto 204 - Ruta Interbalnearia</option>
                        </select>
                    </div>

                    <div class="col-right">
                        <label for="cedula-input">C√©dula de identidad</label>
                        <div class="busqueda-propietario">
                            <input type="text" id="cedula-input" placeholder="12345678" class="input-field">
                            <button id="btn-buscar-propietario" class="btn-primary">Buscar propietario</button>
                        </div>

                        <div class="propietario-resumen">
                            <strong>Propietario</strong>
                            <p>Nombre: <span id="prop-asignacion-nombre">Propietario Demo 12345678</span></p>
                            <p>Estado: <span id="prop-asignacion-estado">Activo</span></p>
                        </div>

                        <div class="bonificaciones-asignadas">
                            <h4>Bonificaciones asignadas</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Bonificaci√≥n</th>
                                            <th>Puesto</th>
                                            <th>Fecha asignaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="3">Sin bonificaciones asignadas</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="asignar-nueva">
                            <h4>Asignar nueva bonificaci√≥n</h4>
                            <p>Seleccione bonificaci√≥n y puesto en las listas de la izquierda y luego asigne.</p>
                            <button id="btn-asignar-bonificacion" class="btn-primary">Asignar bonificaci√≥n</button>
                        </div>
                    </div>
                </div>
            </div>

            <section class="admin-card estado-propietario-section">
                <div class="card-header">
                    <h3 class="card-title">Cambiar estado de propietario</h3>
                </div>

                <div class="card-body">

                    <div class="row">
                        <div class="col-md-6">
                            <label for="select-nuevo-estado">Estados definidos</label>
                            <select id="select-nuevo-estado" class="input-field">
                                <option value="" disabled selected>Seleccione nuevo estado</option>
                                <option value="Activo">Activo</option>
                                <option value="Deshabilitado">Deshabilitado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label style="opacity:0;">Placeholder</label>
                            <button id="btn-cambiar-estado" class="btn-primary" disabled>Cambiar estado</button>
                        </div>
                    </div>

                    <hr>

                    <div id="info-propietario-estado" class="propietario-info-box">
                        <h4>Propietario</h4>
                        <div class="info-line">
                            <span class="info-label">Nombre:</span>
                            <span id="prop-estado-nombre">...</span>
                        </div>
                        <div class="info-line">
                            <span class="info-label">Estado actual:</span>
                            <span id="prop-estado-actual">...</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="footer-admin">
            ¬© 2025 - Administraci√≥n
        </footer>
        <script>
            // ... Todo el c√≥digo JavaScript va aqu√≠
            urlIniciarVista = '/transito/inicializarVista'; // Endpoint para cargar puestos y tarifas iniciales

            // Variable global para almacenar todos los puestos con sus tarifas. 
            let puestosConTarifas = [];
            let inputCedula;
            let selectPuesto;
            let selectBonificacion;
            let selectNuevoEstado;
            let btnCambiarEstado;
            let selectPuestoEmular;

            // --- FUNCI√ìN AUXILIAR DE PINTADO DE TARIFAS ---
            function mostrar_tarifasPuesto(tarifas) {
                const contenedorTabla = document.getElementById('tabla-tarifas');

                if (!tarifas || tarifas.length === 0) {
                    contenedorTabla.innerHTML = '<p class="tarifas-info">No se encontraron tarifas para este puesto.</p>';
                    return;
                }

                const htmlTabla = crearTablaDesdeJson(tarifas);

                contenedorTabla.innerHTML = `
            <span class="tarifas-title">Tarifas del puesto</span>
            <div class="tarifas-muestra">
                ${htmlTabla}
                <p class="tarifas-info">Se muestran categor√≠a y monto actuales del puesto seleccionado.</p>
            </div>
        `;
            }

            // --- FUNCIONES ESPEC√çFICAS DE CARGA (Para llenar los selects) ---

            function mostrar_puestos(puestos) {
                puestosConTarifas = puestos;
                selectPuestoEmular = document.getElementById('puesto');
                const selectPuestoAsignacion = document.getElementById('puestos-select');

                // 1. Limpiar opciones previas
                const defaultOption = '<option value="" disabled selected>Seleccione un puesto</option>';
                selectPuestoEmular.innerHTML = defaultOption;
                selectPuestoAsignacion.innerHTML = defaultOption;

                // 2. Llenar AMBOS selects con los puestos
                puestosConTarifas.forEach(puesto => {

                    const claveUnica = puesto.direccion;
                    const textoVisible = puesto.nombre + ' (' + puesto.direccion + ')';

                    if (claveUnica) {
                        const option = document.createElement('option');

                        option.value = claveUnica;
                        option.textContent = textoVisible;

                        console.log(`‚úÖ Agregando puesto al select (Valor: ${option.value} | Texto: ${option.textContent})`);

                        selectPuestoEmular.appendChild(option.cloneNode(true));
                        selectPuestoAsignacion.appendChild(option);
                    }
                });

                if (puestosConTarifas.length > 0) {
                    const primerPuesto = puestosConTarifas[0];

                    selectPuestoEmular.value = primerPuesto.direccion;

                    mostrar_tarifasPuesto(primerPuesto.tarifas);
                }
            }

            function mostrar_propietario(data) {
                if (!data) {
                    mostrar_error("Error: Propietario no encontrado o datos incompletos.");
                    return;
                }

                // A. Actualizar la informaci√≥n del propietario
                document.getElementById('prop-asignacion-nombre').textContent = data.nombre;
                document.getElementById('prop-asignacion-estado').textContent = data.estado;

                // --- B. CARGAR TABLA DE BONIFICACIONES ASIGNADAS CON crearTablaDesdeJson ---

                // 1. Obtener el contenedor de la tabla (usando la estructura de tu HTML)
                const contenedorTabla = document.querySelector('.bonificaciones-asignadas .table-container');

                // 2. Determinar la fuente de datos (asumiendo que es 'bonificacionesAsignadas' o 'bonificaciones')
                const bonificaciones = data.bonificacionesAsignadas || data.bonificaciones;

                // 3. Generar el HTML de la tabla
                const htmlTabla = crearTablaDesdeJson(bonificaciones);

                // 4. Inyectar el HTML en el contenedor
                contenedorTabla.innerHTML = htmlTabla;

                // 5. Agregar el t√≠tulo (si tu HTML lo ten√≠a por separado, aseg√∫rate de mantenerlo)
                const h4Title = document.createElement('h4');
                h4Title.textContent = 'Bonificaciones asignadas';
                contenedorTabla.prepend(h4Title);

                // Opcional: Mostrar un mensaje de √©xito
                actualizar_todos_los_modulos(data);
                mostrar_mensajeExito(`Propietario ${data.nombre} encontrado correctamente.`);
            }

            function mostrar_estados(estados) {
                const selectEstados = document.getElementById('select-nuevo-estado');

                // 1. Limpiar opciones previas
                selectEstados.innerHTML = '<option value="" disabled selected>Seleccione nuevo estado</option>';

                if (!estados || estados.length === 0) {
                    console.warn("No se recibieron estados del propietario desde el backend.");
                    mostrarMensaje("No se pudieron cargar los estados disponibles.", 'error');
                    return;
                }

                // 2. Llenar el select con los estados recibidos
                estados.forEach(estado => {
                    if (estado && typeof estado === 'string' && estado.trim().length > 0) {
                        const option = document.createElement('option');
                        option.value = estado;
                        option.textContent = estado;
                        selectEstados.appendChild(option);
                    }
                });

                console.log(`‚úÖ ${estados.length} estados cargados correctamente en el select.`);
            }

            function mostrar_estado_propietario(data) {
                const propNombre = document.getElementById('prop-estado-nombre');
                const propEstado = document.getElementById('prop-estado-actual');

                if (!data || data.length === 0) {
                    mostrarMensaje('Propietario no encontrado o datos incompletos.', 'error');
                    propNombre.textContent = '...';
                    propEstado.textContent = '...';
                    btnCambiarEstado.disabled = true;
                    return;
                }

                // Asumimos que data es el objeto del propietario, si el backend retorna un array de un elemento, usamos data[0]
                const propietario = Array.isArray(data) ? data[0] : data;

                if (!propietario.nombre || !propietario.estado) {
                    mostrarMensaje('Datos del propietario incompletos.', 'error');
                    btnCambiarEstado.disabled = true;
                    return;
                }

                // 1. Actualizar la interfaz con los datos
                propNombre.textContent = propietario.nombre;
                propEstado.textContent = propietario.estado; // Mostrar el estado actual

                // 2. Pre-seleccionar el estado actual en el select
                selectNuevoEstado.value = propietario.estado;

                // 3. Habilitar el bot√≥n de acci√≥n
                btnCambiarEstado.disabled = false;

                mostrarMensaje(`Propietario ${propietario.nombre} cargado. Estado actual: ${propietario.estado}`, 'success');
            }

            function mostrar_bonificaciones(bonificaciones) {
                const selectBonificaciones = document.getElementById('bonificaciones-select');

                selectBonificaciones.innerHTML = '<option value="" disabled selected>Seleccione una bonificaci√≥n</option>';

                bonificaciones.forEach(nombre => {
                    const option = document.createElement('option');

                    option.value = nombre;
                    option.textContent = nombre;

                    selectBonificaciones.appendChild(option);

                });
            }

            document.addEventListener("DOMContentLoaded", function () {
                inputCedulaEstado = document.getElementById('input-cedula-estado');
                selectNuevoEstado = document.getElementById('select-nuevo-estado');
                btnCambiarEstado = document.getElementById('btn-cambiar-estado');

                submit('/usuario/getStates', null, 'GET');

                btnCambiarEstado.disabled = true;

                btnCambiarEstado.addEventListener('click', function () {
                    const cedula = inputCedula.value;
                    const nombreEstado = selectNuevoEstado.value;

                    if (!nombreEstado) {
                        mostrarMensaje('Seleccione el nuevo estado.', 'warning');
                        return;
                    }

                    const url = '/usuario/changeState';
                    const parametros = `cedula=${encodeURIComponent(cedula)}&nombreEstado=${encodeURIComponent(nombreEstado)}`;

                    submit(url, parametros, 'POST', mostrar_estado_propietario);
                });



                const btnBuscarPropietario = document.getElementById('btn-buscar-propietario');
                inputCedula = document.getElementById('cedula-input');

                btnBuscarPropietario.addEventListener('click', function () {
                    const cedula = inputCedula.value;

                    if (!cedula || cedula.trim() === '') {
                        mostrarMensaje("Debe ingresar un n√∫mero de c√©dula.", 'warning');
                        return;
                    }

                    const parametros = `cedula=${encodeURIComponent(cedula)}`;
                    submit('/usuario/obtenerUsuario', parametros, 'POST');
                });

                selectPuesto = document.getElementById('puestos-select');
                const btnEmular = document.getElementById('btn-emular-transito');

                selectPuesto.addEventListener('change', function () {
                    const puestoDireccion = this.value;
                    const puestoSeleccionado = puestosConTarifas.find(p => p.direccion === puestoDireccion);

                    if (puestoSeleccionado && puestoSeleccionado.tarifas) {
                        mostrar_tarifasPuesto(puestoSeleccionado.tarifas);
                    } else {
                        document.getElementById('tabla-tarifas').innerHTML = '<p class="tarifas-info">No se encontraron tarifas.</p>';
                    }
                });

                btnAsignarBonificacion = document.getElementById('btn-asignar-bonificacion');
                selectBonificacion = document.getElementById('bonificaciones-select');

                btnAsignarBonificacion.addEventListener('click', function () {
                    const cedula = inputCedula.value;
                    const puestoDireccion = selectPuesto.value;
                    const bonificacionNombre = selectBonificacion.value;

                    if (!cedula || cedula.trim() === '') {
                        mostrarMensaje("Debe buscar un propietario e ingresar su c√©dula.", 'warning');
                        return;
                    }
                    if (!puestoDireccion) {
                        mostrarMensaje("Debe seleccionar un puesto para la asignaci√≥n.", 'warning');
                        return;
                    }
                    if (!bonificacionNombre) {
                        mostrarMensaje("Debe seleccionar una bonificaci√≥n.", 'warning');
                        return;
                    }

                    const parametros =
                        `puestoDireccion=${encodeURIComponent(puestoDireccion)}` +
                        `&bonificacionNombre=${encodeURIComponent(bonificacionNombre)}` +
                        `&cedula=${encodeURIComponent(cedula)}`;

                    const url = '/usuario/asignarBonificacion';

                    submit(url, parametros, 'POST');
                });

                btnEmular.addEventListener('click', function () {
                    const puestoDireccion = selectPuestoEmular.value;
                    const matricula = document.getElementById('matricula').value;
                    const fechaHora = document.getElementById('fechaHora').value;

                    if (!puestoDireccion || !matricula || !fechaHora) {
                        mostrarMensaje("Debe seleccionar un puesto e ingresar matr√≠cula y fecha/hora.");
                        return;
                    }

                    const parametros =
                        `puestoDireccion=${encodeURIComponent(puestoDireccion)}` +
                        `&matricula=${encodeURIComponent(matricula)}` +
                        `&fechaHora=${encodeURIComponent(fechaHora)}`;

                    submit('/transito/emular', parametros, 'POST');
                });
            });

            function actualizar_todos_los_modulos(data) {
                if (!data || data.length === 0 || data.error) {
                    mostrar_error("Propietario no encontrado o error en la b√∫squeda.");
                    actualizar_modulo_asignacion({});
                    actualizar_modulo_estado({});
                    return;
                }

                actualizar_modulo_asignacion(data);
                actualizar_modulo_estado(data);
            }

            function actualizar_modulo_asignacion(data) {
                const propietario = Array.isArray(data) ? data[0] : data;

                if (!propietario || !propietario.nombre || !propietario.estado) {
                    document.getElementById('prop-asignacion-nombre').textContent = '...';
                    document.getElementById('prop-asignacion-estado').textContent = '...';
                    return;
                }

                document.getElementById('prop-asignacion-nombre').textContent = propietario.nombre;
                document.getElementById('prop-asignacion-estado').textContent = propietario.estado;

                // ...
                mostrar_mensajeExito(`Propietario ${propietario.nombre} cargado en Asignaci√≥n.`);
            }

            function actualizar_modulo_estado(data) {
                const propietario = Array.isArray(data) ? data[0] : data;
                const propNombre = document.getElementById('prop-estado-nombre');
                const propEstado = document.getElementById('prop-estado-actual');

                if (!propietario || !propietario.nombre || !propietario.estado) {
                    propNombre.textContent = '...';
                    propEstado.textContent = '...';
                    btnCambiarEstado.disabled = true;
                    return;
                }

                propNombre.textContent = propietario.nombre;
                propEstado.textContent = propietario.estado;
                selectNuevoEstado.value = propietario.estado;
                btnCambiarEstado.disabled = false;
            }

            function mostrar_exito(mensaje) {
                const mensajeFinal = mensaje || "Bonificaci√≥n asignada con √©xito.";

                mostrarMensaje(mensajeFinal, 'success');

                const cedula = inputCedula.value;
                const parametros = `cedula=${encodeURIComponent(cedula)}`;
                submit('/usuario/obtenerUsuario', parametros, 'POST');
            }

            function mostrar_resultadoEmulacion(data) {
                document.getElementById('prop-nombre').textContent = data.propietarioNombre;
                document.getElementById('prop-estado').textContent = data.propietarioEstado;
                document.getElementById('prop-estado-nombre').textContent = data.propietarioNombre;
                document.getElementById('prop-estado-actual').textContent = data.propietarioEstado;
                document.getElementById('transito-categoria').textContent = data.categoria;
                document.getElementById('transito-bonificacion').textContent = data.bonificacionNombre || 'Ninguna';

                document.getElementById('transito-costo').textContent = `$ ${data.costoTransito.toFixed(2)}`;
                document.getElementById('saldo-luego').textContent = `$ ${data.saldoLuego.toFixed(2)}`;
            }

            function mostrar_error(mensaje) {
                mostrarMensaje(`Error en la operaci√≥n: ${mensaje}`, 'error');
            }

            function mostrar_mensajeExito(mensaje) {
                mostrarMensaje(mensaje, 'success');
            }

            document.addEventListener('DOMContentLoaded', function () {
                const salirLink = document.querySelector('.salir-link');
                if (salirLink) {
                    salirLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        submit('/auth/logout', '');
                    });
                }
            });

            function mostrar_usuarioNoAutenticado(url) {
                window.location.href = url;
            }

        </script>
</body>

</html>